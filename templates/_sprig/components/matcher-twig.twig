{# Sprig + Twig Only Implementation #}
{% do sprig.setConfig({ requestClass: 'loading' }) %}
{# Setting attributes values #}
{% set affection = affection ?? currentUser.affection %}
{% set activityLevel = activityLevel ?? currentUser.activityLevel %}
{% set bodySize = bodySize ?? currentUser.bodySize %}
{% set hairyness = hairyness ?? currentUser.hairyness %}
{% set diet = diet ?? currentUser.diet %}
{% set attractiveness = attractiveness ?? currentUser.attractiveness %}

{# Variables to track the best match #}
{% set match = null %}
{% set topScore = 999 %}

{# Get all pawmates #}
{% set pawmates = craft.entries.section('pawmates').all() %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg shadow-2xl p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Step 1: Set your desired pawtner's attributes</h2>
            <div class="space-y-6">
                {# Attributes sliders #}
                {% include('_sprig/components/sliders-twig') %}
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg overflow-hidden" style="min-height: 500px;">
            <div id="indicator" class="flip-card h-full">
                <div class="flip-card-inner">
                    <div class="flip-card-front p-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Step 2: Find Your Pawtner</h2>
                        {# if Sprig request, that means we are finding a pawtner. #}
                        {% if sprig.isRequest() %}
                            {% for pawmate in pawmates %}
                                {# Get the score for this animal #}
                                {% set matchScore = 0 %}
                                {% set matchScore = matchScore + (affection - pawmate.affection) | abs %}
                                {% set matchScore = matchScore + (activityLevel - pawmate.activityLevel) | abs %}
                                {% set matchScore = matchScore + (bodySize - pawmate.bodySize) | abs %}
                                {% set matchScore = matchScore + (hairyness - pawmate.hairyness) | abs %}
                                {% set matchScore = matchScore + (diet - pawmate.diet) | abs %}
                                {% set matchScore = matchScore + (attractiveness - pawmate.attractiveness) | abs %}
                                {% if matchScore < topScore %}
                                    {% set topScore = matchScore %}
                                    {% set match = pawmate %}
                                {% endif %}
                            {% endfor %}
                            {% if match %}
                                <div class="border border-gray-700 rounded-lg overflow-hidden">
                                    {% if match.image|length %}
                                        <img src="{{ match.image.eagerly().one().url('animalProfile') }}" alt="{{ match.title }}"
                                             class="w-full h-64 object-cover">
                                    {% else %}
                                        <div class="w-full h-64 bg-gray-200 flex items-center justify-center">
                                            <span class="text-gray-400 text-6xl">üê∂</span>
                                        </div>
                                    {% endif %}
                                    <div class="p-6">
                                        <h3 class="text-2xl font-bold text-gray-900 mb-3">{{ match.title }}</h3>
                                        {% if match.shortDescription %}
                                            <p class="text-gray-600 mb-4">{{ match.shortDescription }}</p>
                                        {% endif %}
                                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                                            {% if match.age %}
                                                <div><strong>Age:</strong> {{ match.age }}</div>{% endif %}
                                            {% if match.sex %}
                                                <div><strong>Sex:</strong> {{ match.sex.label }}</div>{% endif %}
                                            {% if match.neutered is defined %}
                                                <div><strong>Neutered:</strong> {{ match.neutered ? 'Yes' : 'No' }}
                                                </div>{% endif %}
                                            <div><strong>Match Score:</strong> {{ ((60 - topScore) / 60 * 100)|round }}%
                                            </div>
                                        </div>
                                        <a href="{{ match.url }}"
                                           class="block w-full bg-pink-600 text-white text-center py-3 rounded-lg font-semibold hover:bg-pink-700 transition-colors">
                                            View {{ match.title }}'s Profile
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center py-12">
                                <div class="text-gray-400 text-6xl mb-4">üêæ</div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-2">Start Your Search</h3>
                                <p class="text-gray-500">If you're ready, press the button below. Or adjust the sliders
                                    to find your perfect pawmate match!</p>
                                <button sprig s-indicator="#indicator"
                                        class="mt-4 bg-pink-600 cursor-pointer text-white text-center py-3 px-3 rounded-lg font-semibold hover:bg-pink-700 transition-colors">
                                    Find My Match
                                </button>
                            </div>
                        {% endif %}
                        {# End of Sprig request#}
                    </div>
                    <div class="flip-card-back p-6">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-pink-600 mb-6"></div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Finding Your Match</h3>
                        <p class="text-gray-600">Analyzing compatibility...</p>
                        <div class="mt-6 text-6xl">üêæ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>